<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>æ›²æŸ„æ‘‡æ†æœºæ„ - äº¤äº’å¼æ•™å­¦</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;height:100%;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'PingFang SC','Hiragino Sans GB','Microsoft YaHei','Segoe UI',sans-serif;background:#fff;color:#1a1a1a}
#app{width:100%;height:100%;display:flex;flex-direction:column}
#cards{flex:1;position:relative;overflow:hidden}
.card{position:absolute;top:0;left:0;width:100%;height:100%;padding:20px 20px 0;display:flex;flex-direction:column;transition:transform .45s cubic-bezier(.4,0,.2,1),opacity .45s ease;will-change:transform,opacity}
.card.pos-right{transform:translateX(100%);opacity:0;pointer-events:none}
.card.pos-center{transform:translateX(0);opacity:1}
.card.pos-left{transform:translateX(-100%);opacity:0;pointer-events:none}
.card-title{font-size:22px;font-weight:700;letter-spacing:.5px;margin-bottom:4px;color:#1a1a1a}
.card-subtitle{font-size:13px;color:#888;margin-bottom:12px;font-weight:400}
.card-body{flex:1;display:flex;flex-direction:column;overflow-y:auto;-webkit-overflow-scrolling:touch;padding-bottom:10px}
.svg-wrap{width:100%;display:flex;justify-content:center;margin:4px 0;flex-shrink:0}
.svg-wrap svg{width:100%;max-width:400px}
.card-text{font-size:14px;line-height:1.75;color:#333;padding:0 2px}
.card-text p{margin-bottom:10px}
.formula{background:#f5f5f5;border-radius:8px;padding:12px 16px;margin:10px 0;font-size:15px;text-align:center;font-family:'Times New Roman',serif;letter-spacing:1px;border:1px solid #eee}
.highlight{color:#0C8CE9;font-weight:600}
.key-point{background:#f0f8ff;border-left:3px solid #0C8CE9;padding:10px 14px;margin:10px 0;border-radius:0 8px 8px 0;font-size:13px;line-height:1.7}
.tag{display:inline-block;padding:2px 10px;border-radius:20px;font-size:12px;margin:2px 4px 2px 0;border:1px solid #ddd;color:#555}
.tag-blue{background:#e8f4fd;border-color:#b3d9f2;color:#0C8CE9}
.tag-red{background:#fde8e8;border-color:#f2b3b3;color:#d93025}
.tag-green{background:#e8fde8;border-color:#b3f2b3;color:#1e8e3e}

/* Navigation */
#nav{height:64px;display:flex;align-items:center;justify-content:space-between;padding:0 16px;border-top:1px solid #f0f0f0;background:#fff;flex-shrink:0}
.nav-btn{display:flex;align-items:center;gap:6px;padding:10px 20px;border:none;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit}
.nav-btn:active{transform:scale(.96)}
#prevBtn{background:#f5f5f5;color:#666}
#prevBtn:disabled{opacity:.3;pointer-events:none}
#nextBtn{background:#1a1a1a;color:#fff}
#nextBtn:disabled{opacity:.3}
#dots{display:flex;gap:6px;align-items:center}
.dot{width:6px;height:6px;border-radius:50%;background:#ddd;transition:all .3s}
.dot.active{width:20px;border-radius:3px;background:#1a1a1a}

/* Slider */
.angle-slider-wrap{display:flex;align-items:center;gap:10px;padding:4px 10px;margin:6px 0}
.angle-slider{-webkit-appearance:none;appearance:none;flex:1;height:4px;border-radius:2px;background:#e0e0e0;outline:none}
.angle-slider::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;border-radius:50%;background:#1a1a1a;cursor:grab;border:3px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.3)}
.slider-label{font-size:12px;color:#999;min-width:36px;text-align:center;font-variant-numeric:tabular-nums}

/* Controls */
.ctrl-row{display:flex;gap:8px;margin:6px 0;flex-wrap:wrap}
.ctrl-btn{padding:6px 14px;border:1.5px solid #ddd;border-radius:8px;background:#fff;font-size:13px;cursor:pointer;transition:all .2s;font-family:inherit;color:#555}
.ctrl-btn:active{transform:scale(.96)}
.ctrl-btn.active{border-color:#0C8CE9;color:#0C8CE9;background:#f0f8ff}

/* Lab sliders */
.lab-param{display:flex;align-items:center;gap:8px;margin:4px 0;font-size:13px}
.lab-param label{min-width:60px;color:#666}
.lab-param input[type=range]{flex:1;height:3px;-webkit-appearance:none;appearance:none;background:#e0e0e0;border-radius:2px;outline:none}
.lab-param input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:18px;height:18px;border-radius:50%;background:#1a1a1a;cursor:pointer;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.25)}
.lab-param .val{min-width:32px;text-align:right;font-variant-numeric:tabular-nums;color:#0C8CE9;font-weight:600}

/* Info bar */
.info-bar{display:flex;justify-content:space-around;background:#fafafa;border-radius:8px;padding:8px 4px;margin:6px 0;border:1px solid #f0f0f0}
.info-item{text-align:center}
.info-item .info-label{font-size:11px;color:#999}
.info-item .info-value{font-size:16px;font-weight:700;font-variant-numeric:tabular-nums;color:#1a1a1a}
.info-item .info-value.warn{color:#f59e0b}
.info-item .info-value.bad{color:#d93025}
.info-item .info-value.good{color:#1e8e3e}

/* Drag hint */
.drag-hint{text-align:center;font-size:12px;color:#aaa;margin:4px 0;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:.5}50%{opacity:1}}

/* Title card hero */
.hero-title{font-size:32px;font-weight:800;letter-spacing:1px;margin:20px 0 6px;text-align:center}
.hero-sub{font-size:15px;color:#666;text-align:center;margin-bottom:16px;line-height:1.6}
.hero-tags{display:flex;justify-content:center;flex-wrap:wrap;gap:6px;margin-bottom:10px}

/* Ghost mechanism */
.ghost-link{opacity:.15}
.ghost-joint{opacity:.15}

/* Extreme position highlight */
.extreme-arc{fill:none;stroke-width:2;opacity:.7}

/* Touch handling */
svg{touch-action:none}
.angle-slider{touch-action:none}

/* Scrollbar hide */
.card-body::-webkit-scrollbar{display:none}
.card-body{scrollbar-width:none}

/* Bar chart for Grashof comparison */
.bar-chart{display:flex;align-items:flex-end;gap:10px;justify-content:center;padding:8px 12px;margin:6px 0}
.bar-col{display:flex;flex-direction:column;align-items:center;gap:4px}
.bar-rect{width:42px;border-radius:6px 6px 2px 2px;transition:height .5s cubic-bezier(.4,0,.2,1);min-height:8px}
.bar-label{font-size:11px;color:#999;font-weight:500}
.bar-value{font-size:12px;font-weight:700;color:#1a1a1a}

/* Mechanism type badge */
.mech-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:12px;font-size:13px;font-weight:600;margin:4px 0}
.mech-badge-blue{background:linear-gradient(135deg,#e8f4fd,#d0ebff);color:#0C8CE9;border:1px solid #b3d9f2}
.mech-badge-green{background:linear-gradient(135deg,#e8fde8,#d0ffd0);color:#1e8e3e;border:1px solid #b3f2b3}
.mech-badge-orange{background:linear-gradient(135deg,#fff3e0,#ffe0b2);color:#e65100;border:1px solid #ffcc80}

/* Comparison table */
.compare-row{display:flex;align-items:center;gap:8px;padding:8px 12px;margin:3px 0;border-radius:8px;background:#fafafa;border:1px solid #f0f0f0;font-size:13px}
.compare-row .cr-icon{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0}
.compare-row .cr-text{flex:1;line-height:1.5}
.compare-row .cr-arrow{color:#ccc;font-size:16px;flex-shrink:0}
.compare-row .cr-result{font-weight:700;font-size:13px;flex-shrink:0}

/* Shortest bar highlight pulse */
@keyframes shortPulse{0%,100%{stroke-width:3}50%{stroke-width:5.5}}
.shortest-bar-pulse{animation:shortPulse 1.5s infinite}

/* Legend in SVG cards */
.svg-legend{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:4px 0;padding:4px 8px}
.svg-legend-item{display:flex;align-items:center;gap:4px;font-size:11px;color:#666}
.svg-legend-dot{width:10px;height:10px;border-radius:2px}

/* Card 4 visualization pack */
.grashof-visual-pack{margin-top:10px;padding:10px;border:1px solid #e4edf7;border-radius:12px;background:linear-gradient(180deg,#fcfdff,#f7faff)}
.grashof-visual-title{font-size:13px;font-weight:700;color:#334155;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.mini-mech-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:8px;margin-top:4px}
.mini-mech-card{border:1px solid #e5eaf1;border-radius:10px;padding:6px;background:#fff}
.mini-mech-title{font-size:12px;font-weight:700;line-height:1.35}
.mini-mech-sub{font-size:11px;color:#64748b;margin:2px 0 4px}
.mini-mech-card svg{width:100%;height:124px;display:block;background:#fbfdff;border:1px solid #edf2f7;border-radius:8px}
.mini-chip-row{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px}
.mini-chip{display:inline-block;padding:1px 6px;border-radius:999px;border:1px solid #d6dde6;background:#f8fafc;color:#475569;font-size:10px;line-height:1.5}
.mini-chip-blue{background:#e8f4fd;border-color:#b3d9f2;color:#0C8CE9}
.mini-chip-green{background:#e8fde8;border-color:#b3f2b3;color:#1e8e3e}
.mini-chip-orange{background:#fff3e0;border-color:#ffcc80;color:#e65100}
.mini-map-wrap{margin-top:8px;border:1px solid #edf2f7;border-radius:10px;background:#fff;padding:8px}
.mini-map-title{text-align:center;font-size:11px;color:#64748b;margin-bottom:4px}
.mini-map-wrap svg{width:100%;display:block}
@media (max-width:720px){
  .mini-mech-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div id="app">
<div id="cards">

<!-- Card 0: Title -->
<div class="card pos-center" id="card-0">
  <div class="card-body" style="justify-content:center;align-items:center">
    <div class="hero-title">æ›²æŸ„æ‘‡æ†æœºæ„</div>
    <div class="hero-sub">å¹³é¢å››æ†æœºæ„ä¸­æœ€åŸºæœ¬ã€æœ€å¸¸ç”¨çš„ä¸€ç§<br>é€šè¿‡äº¤äº’åŠ¨ç”»ï¼Œé€æ­¥æŒæ¡å…¶æ ¸å¿ƒåŸç†</div>
    <div class="hero-tags">
      <span class="tag tag-blue">è¿åŠ¨åˆ†æ</span>
      <span class="tag tag-green">Grashofå®šç†</span>
      <span class="tag tag-red">æ€¥å›ç‰¹æ€§</span>
      <span class="tag">ä¼ åŠ¨è§’</span>
      <span class="tag">æ­»ç‚¹</span>
    </div>
    <div class="svg-wrap"><svg id="svg0" viewBox="0 0 380 260"></svg></div>
    <div class="drag-hint">è‡ªåŠ¨æ¼”ç¤ºä¸­ Â· ç‚¹å‡»ä¸‹ä¸€å¼ å¼€å§‹å­¦ä¹ </div>
  </div>
</div>

<!-- Card 1: Components -->
<div class="card pos-right" id="card-1">
  <div class="card-title">è®¤è¯†å››æ†æœºæ„</div>
  <div class="card-subtitle">å››ä¸ªæ„ä»¶ Â· å››ä¸ªè¿åŠ¨å‰¯ Â· ä¸€ä¸ªè‡ªç”±åº¦</div>
  <div class="card-body">
    <div class="svg-wrap"><svg id="svg1" viewBox="0 0 380 260"></svg></div>
    <div class="card-text">
      <p>å¹³é¢å››æ†æœºæ„ç”±<span class="highlight">å››ä¸ªåˆšæ€§æ„ä»¶</span>é€šè¿‡<span class="highlight">å››ä¸ªä½å‰¯ï¼ˆè½¬åŠ¨å‰¯ï¼‰</span>ä¾æ¬¡è¿æ¥è€Œæˆï¼Œæ„æˆå°é—­çš„è¿åŠ¨é“¾ã€‚</p>
      <p><b>å„æ„ä»¶åç§°ï¼š</b></p>
      <p>
        <span class="tag">â‘  æœºæ¶</span> å›ºå®šä¸åŠ¨çš„æ„ä»¶ï¼ˆADï¼‰<br>
        <span class="tag tag-blue">â‘¡ æ›²æŸ„</span> èƒ½åšæ•´å‘¨å›è½¬çš„è¿æ¶æ†ï¼ˆABï¼‰<br>
        <span class="tag">â‘¢ è¿æ†</span> ä¸ä¸æœºæ¶ç›´æ¥ç›¸è¿çš„æ„ä»¶ï¼ˆBCï¼‰<br>
        <span class="tag tag-green">â‘£ æ‘‡æ†</span> åªèƒ½åšå¾€å¤æ‘†åŠ¨çš„è¿æ¶æ†ï¼ˆDCï¼‰
      </p>
      <div class="key-point">è¿æ¶æ†ï¼šä¸æœºæ¶ç›¸è¿çš„æ„ä»¶ï¼ˆæ›²æŸ„ã€æ‘‡æ†ï¼‰<br>è¿æ†ï¼šä¸ä¸æœºæ¶ç›´æ¥ç›¸è¿ï¼Œåšå¤æ‚å¹³é¢è¿åŠ¨</div>
    </div>
  </div>
</div>

<!-- Card 2: Motion Demo -->
<div class="card pos-right" id="card-2">
  <div class="card-title">è¿åŠ¨æ¼”ç¤º</div>
  <div class="card-subtitle">è§‚å¯Ÿå„æ„ä»¶çš„è¿åŠ¨ç‰¹æ€§</div>
  <div class="card-body">
    <div class="svg-wrap"><svg id="svg2" viewBox="0 0 380 260"></svg></div>
    <div class="ctrl-row" id="ctrl2">
      <button class="ctrl-btn active" onclick="toggleAnim(2)">â–¶ æ’­æ”¾</button>
      <button class="ctrl-btn" onclick="toggleTrace(2)">è½¨è¿¹</button>
      <button class="ctrl-btn" onclick="resetTrace(2)">æ¸…é™¤è½¨è¿¹</button>
    </div>
    <div class="angle-slider-wrap">
      <span class="slider-label">0Â°</span>
      <input type="range" class="angle-slider" id="slider2" min="0" max="360" value="0">
      <span class="slider-label" id="sliderVal2">0Â°</span>
    </div>
    <div class="card-text">
      <p><span class="highlight">æ›²æŸ„</span>åšåŒ€é€Ÿæ•´å‘¨è½¬åŠ¨ï¼Œ<span class="highlight">æ‘‡æ†</span>åœ¨ä¸¤æé™ä½ç½®é—´å¾€å¤æ‘†åŠ¨ï¼Œ<span class="highlight">è¿æ†</span>åšå¤æ‚çš„å¹³é¢è¿åŠ¨ã€‚</p>
      <div class="key-point">æ‹–åŠ¨æ»‘å—å¯é€å¸§åˆ†ææœºæ„åœ¨ä»»æ„ä½ç½®çš„çŠ¶æ€</div>
    </div>
  </div>
</div>

<!-- Card 3: Interactive Drag -->
<div class="card pos-right" id="card-3">
  <div class="card-title">åŠ¨æ‰‹è¯•è¯•</div>
  <div class="card-subtitle">æ‹–åŠ¨æ›²æŸ„ç«¯ç‚¹ Â· æ„Ÿå—ä¼ åŠ¨å…³ç³»</div>
  <div class="card-body">
    <div class="svg-wrap"><svg id="svg3" viewBox="0 0 380 260"></svg></div>
    <div class="drag-hint">ğŸ‘† æ‹–åŠ¨è“è‰²åœ†ç‚¹æ¥è½¬åŠ¨æ›²æŸ„</div>
    <div class="info-bar" id="info3">
      <div class="info-item"><div class="info-label">æ›²æŸ„è§’</div><div class="info-value" id="info3-theta">0Â°</div></div>
      <div class="info-item"><div class="info-label">æ‘‡æ†è§’</div><div class="info-value" id="info3-phi">0Â°</div></div>
      <div class="info-item"><div class="info-label">ä¼ åŠ¨è§’</div><div class="info-value" id="info3-mu">0Â°</div></div>
    </div>
    <div class="card-text">
      <p>é€šè¿‡æ‹–åŠ¨æ›²æŸ„ï¼Œç›´è§‚æ„Ÿå—ï¼š</p>
      <p>Â· æ‘‡æ†æ‘†åŠ¨<b>ä¸å‡åŒ€</b>â€”â€”æ›²æŸ„åŒ€é€Ÿè½¬åŠ¨æ—¶ï¼Œæ‘‡æ†æ—¶å¿«æ—¶æ…¢<br>
         Â· ä¼ åŠ¨è§’<b>ä¸æ–­å˜åŒ–</b>â€”â€”å½±å“åŠ›çš„ä¼ é€’æ•ˆç‡<br>
         Â· è¿æ†ä¸Šå„ç‚¹çš„è¿åŠ¨è½¨è¿¹å„ä¸ç›¸åŒ</p>
    </div>
  </div>
</div>

<!-- Card 4: Grashof's Condition Overview -->
<div class="card pos-right" id="card-4">
  <div class="card-title">æ›²æŸ„å­˜åœ¨æ¡ä»¶</div>
  <div class="card-subtitle">Grashof å®šç† Â· æ†é•¿æ¡ä»¶</div>
  <div class="card-body">
    <div class="svg-wrap"><svg id="svg4" viewBox="0 0 380 240"></svg></div>
    <div class="card-text">
      <div class="formula">s + l â‰¤ p + q</div>
      <p>å…¶ä¸­ <b>s</b> ä¸ºæœ€çŸ­æ†ï¼Œ<b>l</b> ä¸ºæœ€é•¿æ†ï¼Œ<b>p</b>ã€<b>q</b> ä¸ºå…¶ä½™ä¸¤æ†ã€‚</p>
      <div class="bar-chart" id="grashofBars">
        <div class="bar-col"><div class="bar-value" id="gb-s-v">55</div><div class="bar-rect" id="gb-s" style="height:36px;background:#0C8CE9"></div><div class="bar-label">s æœ€çŸ­</div></div>
        <div class="bar-col"><div class="bar-value" id="gb-q-v">100</div><div class="bar-rect" id="gb-q" style="height:66px;background:#999"></div><div class="bar-label">p</div></div>
        <div class="bar-col"><div class="bar-value" id="gb-p-v">140</div><div class="bar-rect" id="gb-p" style="height:93px;background:#999"></div><div class="bar-label">q</div></div>
        <div class="bar-col"><div class="bar-value" id="gb-l-v">150</div><div class="bar-rect" id="gb-l" style="height:100px;background:#d93025"></div><div class="bar-label">l æœ€é•¿</div></div>
      </div>
      <div class="info-bar">
        <div class="info-item"><div class="info-label">s + l</div><div class="info-value" style="color:#0C8CE9">205</div></div>
        <div class="info-item"><div class="info-label">æ¯”è¾ƒ</div><div class="info-value good">â‰¤</div></div>
        <div class="info-item"><div class="info-label">p + q</div><div class="info-value" style="color:#1e8e3e">240</div></div>
      </div>
      <p><b>æ»¡è¶³æ†é•¿æ¡ä»¶æ—¶ï¼Œæ ¹æ®æœ€çŸ­æ†çš„ä½ç½®ä¸åŒï¼š</b></p>
      <div class="compare-row" style="border-left:3px solid #0C8CE9">
        <div class="cr-icon" style="background:#e8f4fd;color:#0C8CE9">â‘ </div>
        <div class="cr-text">æœ€çŸ­æ†ä¸º<b>è¿æ¶æ†</b></div>
        <div class="cr-arrow">â†’</div>
        <div class="cr-result" style="color:#0C8CE9">æ›²æŸ„æ‘‡æ†</div>
      </div>
      <div class="compare-row" style="border-left:3px solid #1e8e3e">
        <div class="cr-icon" style="background:#e8fde8;color:#1e8e3e">â‘¡</div>
        <div class="cr-text">æœ€çŸ­æ†ä¸º<b>æœºæ¶</b></div>
        <div class="cr-arrow">â†’</div>
        <div class="cr-result" style="color:#1e8e3e">åŒæ›²æŸ„</div>
      </div>
      <div class="compare-row" style="border-left:3px solid #e65100">
        <div class="cr-icon" style="background:#fff3e0;color:#e65100">â‘¢</div>
        <div class="cr-text">æœ€çŸ­æ†ä¸º<b>è¿æ†</b></div>
        <div class="cr-arrow">â†’</div>
        <div class="cr-result" style="color:#e65100">åŒæ‘‡æ†</div>
      </div>
      <div class="grashof-visual-pack">
        <div class="grashof-visual-title">ä¸‰ç§æœºæ„åŒæ­¥å›¾å½¢æ¼”ç¤ºï¼ˆæ»¡è¶³ s + l â‰¤ p + qï¼‰</div>
        <div class="ctrl-row">
          <button class="ctrl-btn active" id="btn4-mini-play" onclick="toggleCard4MiniAnim(this)">â¸ åŒæ­¥åŠ¨ç”»</button>
          <button class="ctrl-btn" id="btn4-mini-trace" onclick="toggleCard4MiniTrace(this)">æ˜¾ç¤ºè½¨è¿¹</button>
          <button class="ctrl-btn" onclick="resetCard4MiniTrace()">æ¸…é™¤è½¨è¿¹</button>
        </div>
        <div class="mini-mech-grid">
          <div class="mini-mech-card">
            <div class="mini-mech-title" style="color:#0C8CE9">â‘  æ›²æŸ„æ‘‡æ†æœºæ„</div>
            <div class="mini-mech-sub">æœ€çŸ­æ†åœ¨è¿æ¶æ†ï¼ˆaï¼‰</div>
            <svg id="svg4mini-cr" viewBox="0 0 260 170"></svg>
            <div class="mini-chip-row">
              <span class="mini-chip mini-chip-blue">1 æ„ä»¶æ•´å‘¨å›è½¬</span>
              <span class="mini-chip">1 æ„ä»¶å¾€å¤æ‘†åŠ¨</span>
            </div>
          </div>
          <div class="mini-mech-card">
            <div class="mini-mech-title" style="color:#1e8e3e">â‘¡ åŒæ›²æŸ„æœºæ„</div>
            <div class="mini-mech-sub">æœ€çŸ­æ†åœ¨æœºæ¶ï¼ˆdï¼‰</div>
            <svg id="svg4mini-dc" viewBox="0 0 260 170"></svg>
            <div class="mini-chip-row">
              <span class="mini-chip mini-chip-green">2 æ„ä»¶æ•´å‘¨å›è½¬</span>
              <span class="mini-chip">è¿æ†ä½œå¹³é¢è¿åŠ¨</span>
            </div>
          </div>
          <div class="mini-mech-card">
            <div class="mini-mech-title" style="color:#e65100">â‘¢ åŒæ‘‡æ†æœºæ„</div>
            <div class="mini-mech-sub">æœ€çŸ­æ†åœ¨è¿æ†ï¼ˆbï¼‰</div>
            <svg id="svg4mini-dr" viewBox="0 0 260 170"></svg>
            <div class="mini-chip-row">
              <span class="mini-chip mini-chip-orange">2 æ„ä»¶å¾€å¤æ‘†åŠ¨</span>
              <span class="mini-chip">æœ€çŸ­æ†å¯æ•´å‘¨å›è½¬</span>
            </div>
          </div>
        </div>
        <div class="mini-map-wrap">
          <div class="mini-map-title">æœ€çŸ­æ†ä½ç½®å·®å¼‚ç¤ºæ„ï¼ˆè“=æ›²æŸ„æ‘‡æ†ï¼Œç»¿=åŒæ›²æŸ„ï¼Œæ©™=åŒæ‘‡æ†ï¼‰</div>
          <svg id="svg4posmap" viewBox="0 0 380 130"></svg>
        </div>
      </div>
      <div class="drag-hint" style="margin-top:8px">ä¸Šæ–¹å¯åŒæ­¥å¯¹æ¯”ä¸‰ç§æœºæ„ï¼Œä¸‹ä¸€é¡µç»§ç»­é€ä¸€æ·±å…¥ â†’</div>
    </div>
  </div>
</div>

<!-- Card 5: Crank-Rocker Demo -->
<div class="card pos-right" id="card-5">
  <div class="card-title">â‘  æ›²æŸ„æ‘‡æ†æœºæ„</div>
  <div class="card-subtitle">æœ€çŸ­æ†ä¸ºè¿æ¶æ† Â· è¯¥è¿æ¶æ†ä¸ºæ›²æŸ„</div>
  <div class="card-body">
    <div class="svg-wrap"><svg id="svg5cr" viewBox="0 0 380 280"></svg></div>
    <div class="svg-legend">
      <div class="svg-legend-item"><div class="svg-legend-dot" style="background:#0C8CE9"></div>æ›²æŸ„(æœ€çŸ­)</div>
      <div class="svg-legend-item"><div class="svg-legend-dot" style="background:#666"></div>è¿æ†</div>
      <div class="svg-legend-item"><div class="svg-legend-dot" style="background:#1e8e3e"></div>æ‘‡æ†</div>
      <div class="svg-legend-item"><div class="svg-legend-dot" style="background:#aaa"></div>æœºæ¶</div>
    </div>
    <div class="ctrl-row">
      <button class="ctrl-btn active" onclick="toggleAnim('5cr')">â¸ æš‚åœ</button>
      <button class="ctrl-btn" onclick="toggleTrace('5cr')">è½¨è¿¹</button>
    </div>
    <div class="info-bar" id="info5cr">
      <div class="info-item"><div class="info-label">a(æ›²æŸ„)</div><div class="info-value" style="color:#0C8CE9" id="info5cr-a">55</div></div>
      <div class="info-item"><div class="info-label">b(è¿æ†)</div><div class="info-value" id="info5cr-b">150</div></div>
      <div class="info-item"><div class="info-label">c(æ‘‡æ†)</div><div class="info-value" style="color:#1e8e3e" id="info5cr-c">100</div></div>
      <div class="info-item"><div class="info-label">d(æœºæ¶)</div><div class="info-value" id="info5cr-d">140</div></div>
    </div>
    <div class="card-text">
      <div class="mech-badge mech-badge-blue">ğŸ”„ æ›²æŸ„åšæ•´å‘¨è½¬åŠ¨ Â· æ‘‡æ†å¾€å¤æ‘†åŠ¨</div>
      <p><span class="highlight">æœ€çŸ­æ† a = 55</span> ä½œä¸ºè¿æ¶æ†ï¼Œèƒ½å¤Ÿæ•´å‘¨å›è½¬æˆä¸º<b>æ›²æŸ„</b>ã€‚ä¸å…¶ç›¸é‚»çš„å¦ä¸€è¿æ¶æ†ï¼ˆæ‘‡æ†ï¼‰åªèƒ½æ‘†åŠ¨ã€‚</p>
      <div class="key-point">åˆ¤å®šé€»è¾‘ï¼šæœ€çŸ­æ†ä¸æœºæ¶<b>ç›¸é‚»</b>â†’ æœ€çŸ­æ†ä¸ºæ›²æŸ„<br>å¦ä¸€ä¾§è¿æ¶æ†åªèƒ½æ‘†åŠ¨ â†’ å½¢æˆæ›²æŸ„æ‘‡æ†æœºæ„</div>
    </div>
  </div>
</div>

<!-- Card 6: Double-Crank Demo -->
<div class="card pos-right" id="card-6">
  <div class="card-title">â‘¡ åŒæ›²æŸ„æœºæ„</div>
  <div class="card-subtitle">æœ€çŸ­æ†ä¸ºæœºæ¶ Â· ä¸¤è¿æ¶æ†å‡ä¸ºæ›²æŸ„</div>
  <div class="card-body">
    <div class="svg-wrap"><svg id="svg6dc" viewBox="0 0 380 280"></svg></div>
    <div class="svg-legend">
      <div class="svg-legend-item"><div class="svg-legend-dot" style="background:#0C8CE9"></div>æ›²æŸ„1</div>
      <div class="svg-legend-item"><div class="svg-legend-dot" style="background:#666"></div>è¿æ†</div>
      <div class="svg-legend-item"><div class="svg-legend-dot" style="background:#1e8e3e"></div>æ›²æŸ„2</div>
      <div class="svg-legend-item"><div class="svg-legend-dot" style="background:#e65100"></div>æœºæ¶(æœ€çŸ­)</div>
    </div>
    <div class="ctrl-row">
      <button class="ctrl-btn active" onclick="toggleAnim('6dc')">â¸ æš‚åœ</button>
      <button class="ctrl-btn" onclick="toggleTrace('6dc')">è½¨è¿¹</button>
    </div>
    <div class="info-bar" id="info6dc">
      <div class="info-item"><div class="info-label">a(æ›²æŸ„1)</div><div class="info-value" style="color:#0C8CE9" id="info6dc-a">100</div></div>
      <div class="info-item"><div class="info-label">b(è¿æ†)</div><div class="info-value" id="info6dc-b">150</div></div>
      <div class="info-item"><div class="info-label">c(æ›²æŸ„2)</div><div class="info-value" style="color:#1e8e3e" id="info6dc-c">120</div></div>
      <div class="info-item"><div class="info-label">d(æœºæ¶)</div><div class="info-value" style="color:#e65100" id="info6dc-d">60</div></div>
    </div>
    <div class="card-text">
      <div class="mech-badge mech-badge-green">ğŸ”„ğŸ”„ ä¸¤ä¸ªè¿æ¶æ†å‡åšæ•´å‘¨è½¬åŠ¨</div>
      <p><span class="highlight">æœ€çŸ­æ† d = 60</span> ä½œä¸ºæœºæ¶ã€‚ä¸æœºæ¶ç›¸é‚»çš„ä¸¤ä¸ªè¿æ¶æ†éƒ½èƒ½åš<b>æ•´å‘¨å›è½¬</b>ï¼Œå‡ä¸ºæ›²æŸ„ã€‚</p>
      <div class="key-point">åˆ¤å®šé€»è¾‘ï¼šæœ€çŸ­æ†ä¸º<b>æœºæ¶</b><br>ä¸æœºæ¶ç›¸é‚»çš„ä¸¤ä¸ªè¿æ¶æ†å‡å¯æ•´å‘¨å›è½¬<br>â†’ å½¢æˆåŒæ›²æŸ„æœºæ„ï¼ˆåˆç§°å¹³è¡Œå››è¾¹å½¢æœºæ„ï¼‰</div>
    </div>
  </div>
</div>

<!-- Card 7: Double-Rocker Demo -->
<div class="card pos-right" id="card-7">
  <div class="card-title">â‘¢ åŒæ‘‡æ†æœºæ„</div>
  <div class="card-subtitle">æœ€çŸ­æ†ä¸ºè¿æ† Â· ä¸¤è¿æ¶æ†å‡ä¸ºæ‘‡æ†</div>
  <div class="card-body">
    <div class="svg-wrap"><svg id="svg7dr" viewBox="0 0 380 280"></svg></div>
    <div class="svg-legend">
      <div class="svg-legend-item"><div class="svg-legend-dot" style="background:#0C8CE9"></div>æ‘‡æ†1</div>
      <div class="svg-legend-item"><div class="svg-legend-dot" style="background:#e65100"></div>è¿æ†(æœ€çŸ­)</div>
      <div class="svg-legend-item"><div class="svg-legend-dot" style="background:#1e8e3e"></div>æ‘‡æ†2</div>
      <div class="svg-legend-item"><div class="svg-legend-dot" style="background:#aaa"></div>æœºæ¶</div>
    </div>
    <div class="ctrl-row">
      <button class="ctrl-btn active" onclick="toggleAnim('7dr')">â¸ æš‚åœ</button>
      <button class="ctrl-btn" onclick="toggleTrace('7dr')">è½¨è¿¹</button>
    </div>
    <div class="info-bar" id="info7dr">
      <div class="info-item"><div class="info-label">a(æ‘‡æ†1)</div><div class="info-value" style="color:#0C8CE9" id="info7dr-a">100</div></div>
      <div class="info-item"><div class="info-label">b(è¿æ†)</div><div class="info-value" style="color:#e65100" id="info7dr-b">50</div></div>
      <div class="info-item"><div class="info-label">c(æ‘‡æ†2)</div><div class="info-value" style="color:#1e8e3e" id="info7dr-c">110</div></div>
      <div class="info-item"><div class="info-label">d(æœºæ¶)</div><div class="info-value" id="info7dr-d">140</div></div>
    </div>
    <div class="card-text">
      <div class="mech-badge mech-badge-orange">â†”ï¸â†”ï¸ ä¸¤ä¸ªè¿æ¶æ†å‡åšå¾€å¤æ‘†åŠ¨</div>
      <p><span class="highlight">æœ€çŸ­æ† b = 50</span> ä½œä¸ºè¿æ†ã€‚ä¸¤ä¸ªä¸æœºæ¶ç›¸é‚»çš„è¿æ¶æ†<b>éƒ½ä¸èƒ½æ•´å‘¨å›è½¬</b>ï¼Œåªèƒ½åšå¾€å¤æ‘†åŠ¨ï¼Œå‡ä¸ºæ‘‡æ†ã€‚</p>
      <div class="key-point">åˆ¤å®šé€»è¾‘ï¼šæœ€çŸ­æ†ä¸º<b>è¿æ†</b>ï¼ˆä¸ä¸æœºæ¶ç›¸é‚»ï¼‰<br>ä¸¤ä¾§è¿æ¶æ†å‡ä¸èƒ½æ•´å‘¨å›è½¬<br>â†’ å½¢æˆåŒæ‘‡æ†æœºæ„<br>æ³¨æ„ï¼šè¿æ†æœ¬èº«å¯åšæ•´å‘¨å›è½¬ï¼</div>
    </div>
  </div>
</div>

<!-- Card 8: Extreme Positions & Quick Return -->
<div class="card pos-right" id="card-8">
  <div class="card-title">æé™ä½ç½®ä¸æ€¥å›ç‰¹æ€§</div>
  <div class="card-subtitle">æä½å¤¹è§’ Î¸ Â· è¡Œç¨‹é€Ÿæ¯”ç³»æ•° K</div>
  <div class="card-body">
    <div class="svg-wrap"><svg id="svg8" viewBox="0 0 380 270"></svg></div>
    <div class="ctrl-row">
      <button class="ctrl-btn active" onclick="toggleAnim(8)">â–¶ æ’­æ”¾</button>
      <button class="ctrl-btn" onclick="showExtreme(1)">æé™ä½ç½® I</button>
      <button class="ctrl-btn" onclick="showExtreme(2)">æé™ä½ç½® II</button>
    </div>
    <div class="card-text">
      <p>æ›²æŸ„ä¸è¿æ†<b>å…±çº¿</b>æ—¶ï¼Œæ‘‡æ†åˆ°è¾¾<span class="highlight">æé™ä½ç½®</span>ã€‚</p>
      <div class="formula">K = (180Â° + Î¸) / (180Â° - Î¸) â‰ˆ 1.24</div>
      <p><b>K > 1</b> è¡¨ç¤ºå­˜åœ¨<span class="highlight">æ€¥å›ç‰¹æ€§</span>ï¼š</p>
      <p>Â· <span class="tag tag-blue">å·¥ä½œè¡Œç¨‹</span> æ›²æŸ„è½¬è¿‡è¾ƒå¤§è§’åº¦ â†’ é€Ÿåº¦<b>æ…¢</b><br>
         Â· <span class="tag tag-red">ç©ºå›è¡Œç¨‹</span> æ›²æŸ„è½¬è¿‡è¾ƒå°è§’åº¦ â†’ é€Ÿåº¦<b>å¿«</b></p>
      <div class="key-point">æ€¥å›ç‰¹æ€§åœ¨ç‰›å¤´åˆ¨åºŠã€æ‘†åŠ¨å¯¼æ†æœºæ„ç­‰è®¾å¤‡ä¸­æœ‰é‡è¦åº”ç”¨</div>
    </div>
  </div>
</div>

<!-- Card 9: Transmission Angle -->
<div class="card pos-right" id="card-9">
  <div class="card-title">ä¼ åŠ¨è§’</div>
  <div class="card-subtitle">Î¼ è¶Šå¤§ Â· ä¼ åŠ›æ€§èƒ½è¶Šå¥½</div>
  <div class="card-body">
    <div class="svg-wrap"><svg id="svg9" viewBox="0 0 380 260"></svg></div>
    <div class="angle-slider-wrap">
      <span class="slider-label">0Â°</span>
      <input type="range" class="angle-slider" id="slider9" min="0" max="360" value="0">
      <span class="slider-label" id="sliderVal9">0Â°</span>
    </div>
    <div class="info-bar" id="info9">
      <div class="info-item"><div class="info-label">ä¼ åŠ¨è§’ Î¼</div><div class="info-value good" id="info9-mu">â€”</div></div>
      <div class="info-item"><div class="info-label">å‹åŠ›è§’ Î±</div><div class="info-value" id="info9-alpha">â€”</div></div>
      <div class="info-item"><div class="info-label">Î¼_min</div><div class="info-value" id="info9-mumin">â€”</div></div>
    </div>
    <div class="card-text">
      <p><span class="highlight">ä¼ åŠ¨è§’ Î¼</span>ï¼šè¿æ†ä¸ä»åŠ¨ä»¶ï¼ˆæ‘‡æ†ï¼‰åœ¨è½¬åŠ¨å‰¯å¤„æ‰€å¤¹çš„é”è§’ã€‚</p>
      <p><span class="highlight">å‹åŠ›è§’ Î± = 90Â° âˆ’ Î¼</span></p>
      <div class="formula">è®¾è®¡å‡†åˆ™ï¼šÎ¼_min â‰¥ 40Â°</div>
      <div class="key-point">Î¼ = 90Â° æ—¶ä¼ åŠ›æ•ˆæœæœ€ä½³<br>Î¼ è¶Šå°ï¼Œåˆ†åŠ›ä¸­æ— ç”¨åˆ†åŠ›å æ¯”è¶Šå¤§ï¼Œæ•ˆç‡è¶Šä½</div>
    </div>
  </div>
</div>

<!-- Card 10: Dead Points -->
<div class="card pos-right" id="card-10">
  <div class="card-title">æ­»ç‚¹ä½ç½®</div>
  <div class="card-subtitle">å½“ä¼ åŠ¨è§’ Î¼ = 0Â° æ—¶</div>
  <div class="card-body">
    <div class="svg-wrap"><svg id="svg10" viewBox="0 0 380 260"></svg></div>
    <div class="ctrl-row">
      <button class="ctrl-btn" onclick="showDead(1)">æ­»ç‚¹ I</button>
      <button class="ctrl-btn" onclick="showDead(2)">æ­»ç‚¹ II</button>
      <button class="ctrl-btn active" onclick="toggleAnim(10)">â–¶ æ’­æ”¾</button>
    </div>
    <div class="card-text">
      <p>å½“<b>ä»åŠ¨ä»¶ï¼ˆæ‘‡æ†ï¼‰ä¸ºä¸»åŠ¨ä»¶</b>æ—¶ï¼Œè‹¥æ‘‡æ†ä¸è¿æ†<b>å…±çº¿</b>ï¼Œåˆ™æ›²æŸ„ä¸Šæ‰€å—åŠ›é€šè¿‡å…¶è½¬åŠ¨ä¸­å¿ƒï¼Œ<span class="highlight">æ— æ³•é©±åŠ¨æ›²æŸ„è½¬åŠ¨</span>ã€‚</p>
      <p>æ­¤æ—¶ <b>Î¼ = 0Â°</b>ï¼Œæœºæ„å¤„äº<span class="highlight">æ­»ç‚¹</span>ä½ç½®ã€‚</p>
      <div class="key-point"><b>å…‹æœæ­»ç‚¹çš„æ–¹æ³•ï¼š</b><br>
      Â· å®‰è£…é£è½®ï¼Œåˆ©ç”¨æƒ¯æ€§è¶Šè¿‡æ­»ç‚¹<br>
      Â· é‡‡ç”¨å¤šç¼¸æˆ–åŒæœºæ„é”™ç›¸ä½å¸ƒç½®<br>
      Â· æ­»ç‚¹åœ¨æŸäº›åœºåˆä¹Ÿæœ‰åˆ©ç”¨ä»·å€¼ï¼ˆå¦‚å¤¹å…·é”ç´§ï¼‰</div>
    </div>
  </div>
</div>

<!-- Card 11: Lab -->
<div class="card pos-right" id="card-11">
  <div class="card-title">è‡ªç”±å®éªŒå°</div>
  <div class="card-subtitle">è°ƒèŠ‚å‚æ•° Â· æ¢ç´¢æœºæ„ç‰¹æ€§</div>
  <div class="card-body">
    <div class="svg-wrap"><svg id="svg11" viewBox="0 0 380 260"></svg></div>
    <div class="ctrl-row">
      <button class="ctrl-btn active" onclick="toggleAnim(11)">â–¶ æ’­æ”¾</button>
      <button class="ctrl-btn" onclick="toggleTrace(11)">è½¨è¿¹</button>
      <button class="ctrl-btn" onclick="resetTrace(11)">æ¸…é™¤</button>
    </div>
    <div class="lab-param"><label>æ›²æŸ„ a</label><input type="range" id="lab-a" min="20" max="80" value="55"><span class="val" id="lab-a-v">55</span></div>
    <div class="lab-param"><label>è¿æ† b</label><input type="range" id="lab-b" min="60" max="200" value="150"><span class="val" id="lab-b-v">150</span></div>
    <div class="lab-param"><label>æ‘‡æ† c</label><input type="range" id="lab-c" min="40" max="160" value="100"><span class="val" id="lab-c-v">100</span></div>
    <div class="lab-param"><label>æœºæ¶ d</label><input type="range" id="lab-d" min="60" max="200" value="140"><span class="val" id="lab-d-v">140</span></div>
    <div class="info-bar" id="info11">
      <div class="info-item"><div class="info-label">Grashof</div><div class="info-value good" id="info11-grashof">âœ“</div></div>
      <div class="info-item"><div class="info-label">ç±»å‹</div><div class="info-value" id="info11-type" style="font-size:12px">æ›²æŸ„æ‘‡æ†</div></div>
      <div class="info-item"><div class="info-label">Î¼_min</div><div class="info-value" id="info11-mumin">â€”</div></div>
      <div class="info-item"><div class="info-label">K</div><div class="info-value" id="info11-k">â€”</div></div>
    </div>
  </div>
</div>

</div><!-- /cards -->

<div id="nav">
  <button class="nav-btn" id="prevBtn" disabled onclick="go(-1)">â† ä¸Šä¸€å¼ </button>
  <div id="dots"></div>
  <button class="nav-btn" id="nextBtn" onclick="go(1)">ä¸‹ä¸€å¼  â†’</button>
</div>
</div><!-- /app -->

<script>
// ============ CORE: Four-bar linkage solver ============
function solveFB(theta, a, b, c, d, Ax, Ay) {
    const Dx = Ax + d, Dy = Ay;
    const Bx = Ax + a * Math.cos(theta);
    const By = Ay + a * Math.sin(theta);
    const ddx = Dx - Bx, ddy = Dy - By;
    const BD = Math.sqrt(ddx*ddx + ddy*ddy);
    if (BD > b + c - 0.01 || BD < Math.abs(b - c) + 0.01) return null;
    const aBD = Math.atan2(ddy, ddx);
    const cosB = (BD*BD + b*b - c*c) / (2*BD*b);
    const angB = Math.acos(Math.max(-1, Math.min(1, cosB)));
    const aBC = aBD - angB;
    const Cx = Bx + b * Math.cos(aBC);
    const Cy = By + b * Math.sin(aBC);
    // Transmission angle
    const CBx = Bx-Cx, CBy = By-Cy, CDx = Dx-Cx, CDy = Dy-Cy;
    const dot = CBx*CDx + CBy*CDy;
    let mu = Math.acos(Math.max(-1, Math.min(1, dot/(b*c))));
    if (mu > Math.PI/2) mu = Math.PI - mu;
    // Rocker angle from frame (above frame is negative in SVG)
    const rockAng = Math.atan2(Cy-Dy, Cx-Dx);
    return {Bx,By,Cx,Cy,Dx,Dy,mu,rockAng,aBC};
}

// ============ SVG helpers ============
const NS = 'http://www.w3.org/2000/svg';
function mkEl(parent, tag, attrs) {
    const el = document.createElementNS(NS, tag);
    for (const [k,v] of Object.entries(attrs||{})) el.setAttribute(k,v);
    parent.appendChild(el);
    return el;
}
function setL(el, x1, y1, x2, y2) {
    el.setAttribute('x1',x1); el.setAttribute('y1',y1);
    el.setAttribute('x2',x2); el.setAttribute('y2',y2);
}
function setC(el, cx, cy) { el.setAttribute('cx',cx); el.setAttribute('cy',cy); }

// ============ Mechanism view ============
const views = {};
function createView(svgId, opts) {
    const svg = document.getElementById(svgId);
    if (!svg) return null;
    const o = Object.assign({
        a:55, b:150, c:100, d:140, Ax:100, Ay:195,
        showLabels:false, showTrace:false, showGround:true,
        interactive:false, showAngle:false, crankColor:'#1a1a1a',
        couplerColor:'#1a1a1a', rockerColor:'#1a1a1a'
    }, opts);
    const Dx = o.Ax + o.d, Dy = o.Ay;
    const els = {};

    // Ground hatching
    if (o.showGround) {
        const gy = o.Ay;
        mkEl(svg,'line',{x1:o.Ax-25,y1:gy,x2:Dx+25,y2:gy,stroke:'#bbb','stroke-width':1});
        for (let px of [o.Ax, Dx]) {
            for (let i=-2;i<=2;i++) {
                mkEl(svg,'line',{x1:px+i*7,y1:gy,x2:px+i*7-5,y2:gy+9,stroke:'#bbb','stroke-width':1});
            }
        }
    }

    // Frame link (dashed)
    els.frame = mkEl(svg,'line',{x1:o.Ax,y1:o.Ay,x2:Dx,y2:Dy,stroke:'#ccc','stroke-width':1.5,'stroke-dasharray':'6,4'});

    // Trace path
    els.trace = mkEl(svg,'path',{fill:'none',stroke:'#0C8CE9','stroke-width':1.5,opacity:.6,d:''});

    // Ghost elements (for extreme positions etc)
    els.ghostGroup = mkEl(svg,'g',{opacity:'0.18'});
    els.ghost1Crank = mkEl(els.ghostGroup,'line',{stroke:'#1a1a1a','stroke-width':2.5});
    els.ghost1Coupler = mkEl(els.ghostGroup,'line',{stroke:'#1a1a1a','stroke-width':2.5});
    els.ghost1Rocker = mkEl(els.ghostGroup,'line',{stroke:'#1a1a1a','stroke-width':2.5});
    els.ghost2Crank = mkEl(els.ghostGroup,'line',{stroke:'#1a1a1a','stroke-width':2.5});
    els.ghost2Coupler = mkEl(els.ghostGroup,'line',{stroke:'#1a1a1a','stroke-width':2.5});
    els.ghost2Rocker = mkEl(els.ghostGroup,'line',{stroke:'#1a1a1a','stroke-width':2.5});
    els.ghostGroup.style.display = 'none';

    // Angle arc group
    els.angleGroup = mkEl(svg,'g',{});
    els.angleArc = mkEl(els.angleGroup,'path',{fill:'rgba(12,140,233,0.12)',stroke:'#0C8CE9','stroke-width':1.5,d:''});
    els.angleTxt = mkEl(els.angleGroup,'text',{'font-size':13,'font-weight':600,fill:'#0C8CE9','text-anchor':'middle',dy:'.35em'});
    if (!o.showAngle) els.angleGroup.style.display = 'none';

    // Extreme arcs group
    els.extremeGroup = mkEl(svg,'g',{});
    els.extremeGroup.style.display = 'none';
    els.workArc = mkEl(els.extremeGroup,'path',{fill:'none',stroke:'#0C8CE9','stroke-width':2.5,'stroke-dasharray':'6,3',opacity:.6});
    els.returnArc = mkEl(els.extremeGroup,'path',{fill:'none',stroke:'#d93025','stroke-width':2.5,'stroke-dasharray':'6,3',opacity:.6});
    els.thetaArc = mkEl(els.extremeGroup,'path',{fill:'rgba(233,60,12,0.1)',stroke:'#d93025','stroke-width':1.5});
    els.thetaTxt = mkEl(els.extremeGroup,'text',{'font-size':12,'font-weight':600,fill:'#d93025','text-anchor':'middle',dy:'.35em'});

    // Links
    els.crank = mkEl(svg,'line',{stroke:o.crankColor,'stroke-width':3,'stroke-linecap':'round'});
    els.coupler = mkEl(svg,'line',{stroke:o.couplerColor,'stroke-width':3,'stroke-linecap':'round'});
    els.rocker = mkEl(svg,'line',{stroke:o.rockerColor,'stroke-width':3,'stroke-linecap':'round'});

    // Joints
    els.jA = mkEl(svg,'circle',{cx:o.Ax,cy:o.Ay,r:5,fill:'#1a1a1a',stroke:'#fff','stroke-width':1.5});
    els.jD = mkEl(svg,'circle',{cx:Dx,cy:Dy,r:5,fill:'#1a1a1a',stroke:'#fff','stroke-width':1.5});
    els.jB = mkEl(svg,'circle',{cx:0,cy:0,r:5,fill:'#fff',stroke:'#1a1a1a','stroke-width':2});
    els.jC = mkEl(svg,'circle',{cx:0,cy:0,r:5,fill:'#fff',stroke:'#1a1a1a','stroke-width':2});

    // Labels
    if (o.showLabels) {
        els.lA = mkEl(svg,'text',{x:o.Ax,y:o.Ay+22,'font-size':13,'text-anchor':'middle',fill:'#999',dy:'.35em'});
        els.lA.textContent = 'A';
        els.lD = mkEl(svg,'text',{x:Dx,y:Dy+22,'font-size':13,'text-anchor':'middle',fill:'#999',dy:'.35em'});
        els.lD.textContent = 'D';
        els.lB = mkEl(svg,'text',{'font-size':13,fill:'#0C8CE9','font-weight':600,dy:'.35em'});
        els.lB.textContent = 'B';
        els.lC = mkEl(svg,'text',{'font-size':13,fill:'#1e8e3e','font-weight':600,dy:'.35em'});
        els.lC.textContent = 'C';
        // Link labels
        els.lCrank = mkEl(svg,'text',{'font-size':11,fill:'#0C8CE9','text-anchor':'middle',dy:'.35em'});
        els.lCrank.textContent = 'æ›²æŸ„ a';
        els.lCoupler = mkEl(svg,'text',{'font-size':11,fill:'#666','text-anchor':'middle',dy:'.35em'});
        els.lCoupler.textContent = 'è¿æ† b';
        els.lRocker = mkEl(svg,'text',{'font-size':11,fill:'#1e8e3e','text-anchor':'middle',dy:'.35em'});
        els.lRocker.textContent = 'æ‘‡æ† c';
        els.lFrame = mkEl(svg,'text',{x:(o.Ax+Dx)/2, y:o.Ay+18,'font-size':11,fill:'#999','text-anchor':'middle',dy:'.35em'});
        els.lFrame.textContent = 'æœºæ¶ d';
    }

    // Interactive drag handle
    if (o.interactive) {
        els.dragHandle = mkEl(svg,'circle',{cx:0,cy:0,r:20,fill:'rgba(12,140,233,0.15)',stroke:'#0C8CE9','stroke-width':2,cursor:'grab'});
        // Override joint B appearance
        els.jB.setAttribute('r', 6);
        els.jB.setAttribute('fill', '#0C8CE9');
        els.jB.setAttribute('stroke', '#fff');
    }

    const state = { theta:0, animId:null, tracePoints:[], dragging:false, showTrace:o.showTrace, playing:false, speed:0.015 };

    function update(theta) {
        state.theta = theta;
        const p = solveFB(theta, o.a, o.b, o.c, o.d, o.Ax, o.Ay);
        if (!p) return null;

        setL(els.crank, o.Ax, o.Ay, p.Bx, p.By);
        setL(els.coupler, p.Bx, p.By, p.Cx, p.Cy);
        setL(els.rocker, Dx, Dy, p.Cx, p.Cy);
        setC(els.jB, p.Bx, p.By);
        setC(els.jC, p.Cx, p.Cy);

        if (els.dragHandle) { setC(els.dragHandle, p.Bx, p.By); }

        if (o.showLabels) {
            const offB = theta > Math.PI ? 14 : -14;
            els.lB.setAttribute('x', p.Bx - 14);
            els.lB.setAttribute('y', p.By + (Math.sin(theta)>0 ? 14 : -10));
            els.lC.setAttribute('x', p.Cx + 10);
            els.lC.setAttribute('y', p.Cy - 8);
            // Link midpoints
            els.lCrank.setAttribute('x', (o.Ax+p.Bx)/2 - 10);
            els.lCrank.setAttribute('y', (o.Ay+p.By)/2 + (Math.sin(theta)>0?14:-14));
            els.lCoupler.setAttribute('x', (p.Bx+p.Cx)/2);
            els.lCoupler.setAttribute('y', (p.By+p.Cy)/2 - 10);
            els.lRocker.setAttribute('x', (Dx+p.Cx)/2 + 14);
            els.lRocker.setAttribute('y', (Dy+p.Cy)/2);
        }

        if (state.showTrace) {
            state.tracePoints.push({x:p.Cx, y:p.Cy});
            if (state.tracePoints.length > 500) state.tracePoints = state.tracePoints.slice(-500);
            els.trace.setAttribute('d', state.tracePoints.map((pt,i)=>(i?'L':'M')+pt.x.toFixed(1)+','+pt.y.toFixed(1)).join(''));
        }

        // Transmission angle arc
        if (o.showAngle) {
            drawAngleArc(els, p, o);
        }

        return p;
    }

    function drawAngleArc(els, p, o) {
        const r = 28;
        // Angle at C between CB and CD
        const aCB = Math.atan2(p.By-p.Cy, p.Bx-p.Cx);
        const aCD = Math.atan2(Dy-p.Cy, Dx-p.Cx);
        let start = aCD, end = aCB;
        // Ensure we draw the acute angle
        let diff = end - start;
        while (diff < -Math.PI) diff += 2*Math.PI;
        while (diff > Math.PI) diff -= 2*Math.PI;
        if (Math.abs(diff) > Math.PI/2) {
            // Draw supplement
            if (diff > 0) { start = aCB; end = aCD + Math.PI; }
            else { start = aCD + Math.PI; end = aCB; }
            diff = end - start;
            while (diff < -Math.PI) diff += 2*Math.PI;
            while (diff > Math.PI) diff -= 2*Math.PI;
        }
        const sx = p.Cx + r*Math.cos(start), sy = p.Cy + r*Math.sin(start);
        const ex = p.Cx + r*Math.cos(end), ey = p.Cy + r*Math.sin(end);
        const large = Math.abs(diff) > Math.PI ? 1 : 0;
        const sweep = diff > 0 ? 1 : 0;
        els.angleArc.setAttribute('d',
            `M${p.Cx},${p.Cy}L${sx},${sy}A${r},${r} 0 ${large},${sweep} ${ex},${ey}Z`);
        const mid = start + diff/2;
        els.angleTxt.setAttribute('x', p.Cx + (r+16)*Math.cos(mid));
        els.angleTxt.setAttribute('y', p.Cy + (r+16)*Math.sin(mid));
        els.angleTxt.textContent = (p.mu*180/Math.PI).toFixed(1)+'Â°';
    }

    function startAnim() {
        state.playing = true;
        function frame() {
            state.theta += state.speed;
            if (state.theta > Math.PI*2) state.theta -= Math.PI*2;
            update(state.theta);
            // Sync slider if exists
            const sl = document.getElementById('slider'+svgId.replace('svg',''));
            if (sl && !state.dragging) {
                sl.value = (state.theta * 180 / Math.PI).toFixed(0);
                const vl = document.getElementById('sliderVal'+svgId.replace('svg',''));
                if (vl) vl.textContent = sl.value + 'Â°';
            }
            state.animId = requestAnimationFrame(frame);
        }
        state.animId = requestAnimationFrame(frame);
    }

    function stopAnim() {
        state.playing = false;
        if (state.animId) { cancelAnimationFrame(state.animId); state.animId = null; }
    }

    // Drag interaction
    if (o.interactive) {
        function getAngle(e) {
            const r = svg.getBoundingClientRect();
            const vb = svg.viewBox.baseVal;
            const sx = (e.clientX - r.left) / r.width * vb.width + vb.x;
            const sy = (e.clientY - r.top) / r.height * vb.height + vb.y;
            return Math.atan2(sy - o.Ay, sx - o.Ax);
        }
        els.dragHandle.addEventListener('pointerdown', e => {
            state.dragging = true;
            stopAnim();
            els.dragHandle.setPointerCapture(e.pointerId);
            els.dragHandle.style.cursor = 'grabbing';
            e.preventDefault();
        });
        svg.addEventListener('pointermove', e => {
            if (!state.dragging) return;
            const th = getAngle(e);
            update(th);
            // Update info
            const p = solveFB(th, o.a, o.b, o.c, o.d, o.Ax, o.Ay);
            if (p && o.onUpdate) o.onUpdate(th, p);
        });
        const endDrag = () => { state.dragging = false; els.dragHandle.style.cursor = 'grab'; };
        svg.addEventListener('pointerup', endDrag);
        svg.addEventListener('pointercancel', endDrag);
    }

    const v = { update, startAnim, stopAnim, state, els, o, svg, Dx, Dy };
    views[svgId] = v;
    update(0);
    return v;
}

// ============ Card Navigation ============
const TOTAL_CARDS = 12;
let currentCard = 0;
const dots = document.getElementById('dots');
for (let i = 0; i < TOTAL_CARDS; i++) {
    const d = document.createElement('div');
    d.className = 'dot' + (i===0?' active':'');
    dots.appendChild(d);
}

function go(dir) {
    const next = currentCard + dir;
    if (next < 0 || next >= TOTAL_CARDS) return;
    const curEl = document.getElementById('card-'+currentCard);
    const nxtEl = document.getElementById('card-'+next);
    // Deactivate current card animations
    deactivateCard(currentCard);
    if (dir > 0) {
        curEl.className = 'card pos-left';
        nxtEl.className = 'card pos-center';
    } else {
        curEl.className = 'card pos-right';
        nxtEl.className = 'card pos-center';
    }
    currentCard = next;
    activateCard(currentCard);
    // Update dots
    document.querySelectorAll('.dot').forEach((d,i) => d.className = 'dot'+(i===currentCard?' active':''));
    // Update buttons
    document.getElementById('prevBtn').disabled = currentCard === 0;
    document.getElementById('nextBtn').disabled = currentCard === TOTAL_CARDS - 1;
}

// Card-specific activation/deactivation
// Map card index to svgId for cards with non-numeric IDs
const cardSvgMap = {5:'svg5cr', 6:'svg6dc', 7:'svg7dr'};
const card4MiniSvgIds = ['svg4mini-cr', 'svg4mini-dc', 'svg4mini-dr'];
let card4MiniPlaying = true;
let card4MiniTraceOn = false;
function getSvgId(idx) { return cardSvgMap[idx] || ('svg'+idx); }

function activateCard(idx) {
    const svgId = getSvgId(idx);
    const v = views[svgId];
    if (!v) return;
    // Auto-play animation cards
    if ([0, 2, 5, 6, 7, 8, 10].includes(idx)) {
        v.startAnim();
        const btns = document.querySelectorAll('#card-'+idx+' .ctrl-btn');
        btns.forEach(b => { if(b.textContent.includes('æ’­æ”¾')||b.textContent.includes('æš‚åœ')) { b.textContent='â¸ æš‚åœ'; b.classList.add('active'); }});
    }
    if (idx === 4 && card4MiniPlaying) {
        setCard4MiniPlayback(true);
    }
    if (idx === 11 && v.state.playing) v.startAnim();
}

function deactivateCard(idx) {
    const svgId = getSvgId(idx);
    const v = views[svgId];
    if (v) v.stopAnim();
    if (idx === 4) {
        setCard4MiniPlayback(false);
    }
}

// ============ Slider controls ============
function setupSlider(sliderId, svgId) {
    const slider = document.getElementById(sliderId);
    if (!slider) return;
    slider.addEventListener('input', function() {
        const v = views[svgId];
        if (!v) return;
        v.stopAnim();
        const theta = parseFloat(this.value) * Math.PI / 180;
        v.update(theta);
        const vl = document.getElementById(sliderId.replace('slider','sliderVal'));
        if (vl) vl.textContent = this.value + 'Â°';
        // Update buttons
        const btns = document.querySelectorAll('#card-'+svgId.replace('svg','')+' .ctrl-btn');
        btns.forEach(b => { if(b.textContent.includes('æš‚åœ')) { b.textContent='â–¶ æ’­æ”¾'; b.classList.remove('active'); }});
    });
}

// ============ Control functions ============
function toggleAnim(cardIdx) {
    const svgId = typeof cardIdx === 'string' ? 'svg'+cardIdx : getSvgId(cardIdx);
    const cardId = typeof cardIdx === 'string' ? cardIdx : cardIdx;
    const v = views[svgId];
    if (!v) return;
    if (v.state.playing) {
        v.stopAnim();
        const btns = document.querySelectorAll('[id^="card-"] .ctrl-btn');
        // Find the right card's buttons
        const card = v.svg.closest('.card');
        if (card) card.querySelectorAll('.ctrl-btn').forEach(b => { if(b.textContent.includes('æš‚åœ')) { b.textContent='â–¶ æ’­æ”¾'; b.classList.remove('active'); }});
    } else {
        v.startAnim();
        const card = v.svg.closest('.card');
        if (card) card.querySelectorAll('.ctrl-btn').forEach(b => { if(b.textContent.includes('æ’­æ”¾')) { b.textContent='â¸ æš‚åœ'; b.classList.add('active'); }});
    }
}

function toggleTrace(cardIdx) {
    const svgId = typeof cardIdx === 'string' ? 'svg'+cardIdx : getSvgId(cardIdx);
    const v = views[svgId];
    if (!v) return;
    v.state.showTrace = !v.state.showTrace;
    if (!v.state.showTrace) { v.els.trace.setAttribute('d',''); v.state.tracePoints=[]; }
    const card = v.svg.closest('.card');
    if (card) card.querySelectorAll('.ctrl-btn').forEach(b => { if(b.textContent.includes('è½¨è¿¹')) b.classList.toggle('active'); });
}

function resetTrace(cardIdx) {
    const svgId = typeof cardIdx === 'string' ? 'svg'+cardIdx : getSvgId(cardIdx);
    const v = views[svgId];
    if (!v) return;
    v.state.tracePoints = [];
    v.els.trace.setAttribute('d','');
}

function configureOscillatingView(v, scanStep = 0.005) {
    if (!v) return;
    let minT = null, maxT = null;
    for (let t = 0; t < Math.PI*2; t += scanStep) {
        const p = solveFB(t, v.o.a, v.o.b, v.o.c, v.o.d, v.o.Ax, v.o.Ay);
        if (!p) continue;
        if (minT === null) minT = t;
        maxT = t;
    }
    if (minT === null || maxT === null) return;
    minT += 0.02;
    maxT -= 0.02;
    if (minT >= maxT) {
        minT = Math.max(0, minT - 0.03);
        maxT = Math.min(Math.PI * 2, minT + 0.06);
    }
    v.state.theta = (minT + maxT) / 2;
    v.state._oscillateMin = minT;
    v.state._oscillateMax = maxT;
    v.state._oscillateDir = 1;
    v.update(v.state.theta);

    v.startAnim = function() {
        v.state.playing = true;
        if (v.state.animId) cancelAnimationFrame(v.state.animId);
        function frame() {
            v.state.theta += v.state.speed * v.state._oscillateDir;
            if (v.state.theta >= v.state._oscillateMax) {
                v.state.theta = v.state._oscillateMax;
                v.state._oscillateDir = -1;
            } else if (v.state.theta <= v.state._oscillateMin) {
                v.state.theta = v.state._oscillateMin;
                v.state._oscillateDir = 1;
            }
            v.update(v.state.theta);
            v.state.animId = requestAnimationFrame(frame);
        }
        v.state.animId = requestAnimationFrame(frame);
    };
}

function setCard4MiniPlayback(playing) {
    card4MiniSvgIds.forEach(svgId => {
        const v = views[svgId];
        if (!v) return;
        if (playing) v.startAnim();
        else v.stopAnim();
    });
}

function toggleCard4MiniAnim(btn) {
    card4MiniPlaying = !card4MiniPlaying;
    if (currentCard === 4 && card4MiniPlaying) setCard4MiniPlayback(true);
    else setCard4MiniPlayback(false);
    if (!btn) return;
    btn.textContent = card4MiniPlaying ? 'â¸ åŒæ­¥åŠ¨ç”»' : 'â–¶ åŒæ­¥åŠ¨ç”»';
    btn.classList.toggle('active', card4MiniPlaying);
}

function toggleCard4MiniTrace(btn) {
    card4MiniTraceOn = !card4MiniTraceOn;
    card4MiniSvgIds.forEach(svgId => {
        const v = views[svgId];
        if (!v) return;
        v.state.showTrace = card4MiniTraceOn;
        if (!card4MiniTraceOn) {
            v.state.tracePoints = [];
            v.els.trace.setAttribute('d', '');
        }
    });
    if (!btn) return;
    btn.classList.toggle('active', card4MiniTraceOn);
    btn.textContent = card4MiniTraceOn ? 'éšè—è½¨è¿¹' : 'æ˜¾ç¤ºè½¨è¿¹';
}

function resetCard4MiniTrace() {
    card4MiniSvgIds.forEach(svgId => {
        const v = views[svgId];
        if (!v) return;
        v.state.tracePoints = [];
        v.els.trace.setAttribute('d', '');
    });
}

function initCard4MiniVisuals() {
    createView('svg4mini-cr', {
        showGround:true, showTrace:false,
        a:35, b:92, c:62, d:86, Ax:44, Ay:126,
        crankColor:'#0C8CE9', couplerColor:'#666', rockerColor:'#1e8e3e'
    });
    const vCr = views['svg4mini-cr'];
    if (vCr) {
        vCr.state.speed = 0.02;
        vCr.els.crank.classList.add('shortest-bar-pulse');
        vCr.els.trace.setAttribute('stroke', '#0C8CE9');
    }

    createView('svg4mini-dc', {
        showGround:true, showTrace:false,
        a:58, b:92, c:70, d:36, Ax:106, Ay:126,
        crankColor:'#0C8CE9', couplerColor:'#666', rockerColor:'#1e8e3e'
    });
    const vDc = views['svg4mini-dc'];
    if (vDc) {
        vDc.state.speed = 0.02;
        vDc.els.frame.setAttribute('stroke', '#1e8e3e');
        vDc.els.frame.setAttribute('stroke-dasharray', 'none');
        vDc.els.frame.setAttribute('stroke-width', '3');
        vDc.els.frame.classList.add('shortest-bar-pulse');
        vDc.els.trace.setAttribute('stroke', '#1e8e3e');
    }

    createView('svg4mini-dr', {
        showGround:true, showTrace:false,
        a:62, b:32, c:68, d:86, Ax:44, Ay:126,
        crankColor:'#0C8CE9', couplerColor:'#e65100', rockerColor:'#1e8e3e'
    });
    const vDr = views['svg4mini-dr'];
    if (vDr) {
        vDr.state.speed = 0.02;
        vDr.els.coupler.classList.add('shortest-bar-pulse');
        vDr.els.trace.setAttribute('stroke', '#e65100');
        configureOscillatingView(vDr, 0.01);
    }

    drawCard4PositionMap();
    setCard4MiniPlayback(false);
}

function drawCard4PositionMap() {
    const svg = document.getElementById('svg4posmap');
    if (!svg) return;
    svg.innerHTML = '';

    const schemes = [
        { cx:65, title:'â‘  è¿æ¶æ†æœ€çŸ­', result:'æ›²æŸ„æ‘‡æ†', shortest:'a', color:'#0C8CE9' },
        { cx:190, title:'â‘¡ æœºæ¶æœ€çŸ­', result:'åŒæ›²æŸ„', shortest:'d', color:'#1e8e3e' },
        { cx:315, title:'â‘¢ è¿æ†æœ€çŸ­', result:'åŒæ‘‡æ†', shortest:'b', color:'#e65100' }
    ];

    schemes.forEach(s => {
        mkEl(svg, 'rect', {
            x:s.cx-58, y:8, width:116, height:112, rx:10,
            fill:'#f8fafc', stroke:'#e2e8f0', 'stroke-width':1
        });

        const A = {x:s.cx-32, y:88};
        const B = {x:s.cx-18, y:52};
        const C = {x:s.cx+18, y:52};
        const D = {x:s.cx+32, y:88};

        const base = '#9aa4b2';
        const colorA = s.shortest === 'a' ? s.color : base;
        const colorB = s.shortest === 'b' ? s.color : base;
        const colorC = s.shortest === 'c' ? s.color : base;
        const colorD = s.shortest === 'd' ? s.color : base;
        const sw = k => (s.shortest === k ? 4 : 2);

        mkEl(svg, 'line', {x1:A.x,y1:A.y,x2:B.x,y2:B.y,stroke:colorA,'stroke-width':sw('a'),'stroke-linecap':'round'});
        mkEl(svg, 'line', {x1:B.x,y1:B.y,x2:C.x,y2:C.y,stroke:colorB,'stroke-width':sw('b'),'stroke-linecap':'round'});
        mkEl(svg, 'line', {x1:D.x,y1:D.y,x2:C.x,y2:C.y,stroke:colorC,'stroke-width':sw('c'),'stroke-linecap':'round'});
        mkEl(svg, 'line', {
            x1:A.x, y1:A.y, x2:D.x, y2:D.y,
            stroke:colorD, 'stroke-width':sw('d'),
            'stroke-dasharray':s.shortest === 'd' ? '' : '4,3',
            'stroke-linecap':'round'
        });

        [A, B, C, D].forEach(p => mkEl(svg, 'circle', {cx:p.x, cy:p.y, r:3.2, fill:'#fff', stroke:'#334155', 'stroke-width':1.2}));

        const mids = {
            a:{x:(A.x+B.x)/2, y:(A.y+B.y)/2},
            b:{x:(B.x+C.x)/2, y:(B.y+C.y)/2},
            c:{x:(D.x+C.x)/2, y:(D.y+C.y)/2},
            d:{x:(A.x+D.x)/2, y:(A.y+D.y)/2}
        };
        const star = mids[s.shortest];
        const st = mkEl(svg, 'text', {x:star.x, y:star.y-8, 'font-size':10, fill:s.color, 'font-weight':700, 'text-anchor':'middle'});
        st.textContent = 'â˜…';

        const t1 = mkEl(svg, 'text', {x:s.cx, y:24, 'font-size':11, 'font-weight':700, fill:s.color, 'text-anchor':'middle'});
        t1.textContent = s.title;
        const t2 = mkEl(svg, 'text', {x:s.cx, y:112, 'font-size':10, 'font-weight':600, fill:'#475569', 'text-anchor':'middle'});
        t2.textContent = 'â†’ ' + s.result;
    });
}

// ============ Extreme positions ============
function normalizeAngle(theta) {
    const twoPi = Math.PI * 2;
    let t = theta % twoPi;
    if (t < 0) t += twoPi;
    return t;
}

function cwDelta(startTheta, endTheta) {
    let d = normalizeAngle(endTheta) - normalizeAngle(startTheta);
    if (d < 0) d += Math.PI * 2;
    return d;
}

function getExtremeThetas(a, b, c, d, Ax, Ay) {
    // Pick a theta candidate by solving then enforcing AB // BC.
    // wantOverlap=true means AB and BC opposite direction (dot < 0).
    function pickCollinearTheta(candidates, wantOverlap) {
        const ab = Math.max(1e-6, a * b);
        let bestMatch = null;
        let bestAny = null;

        for (const rawTheta of candidates) {
            const theta = normalizeAngle(rawTheta);
            const p = solveFB(theta, a, b, c, d, Ax, Ay);
            if (!p) continue;

            const ABx = p.Bx - Ax, ABy = p.By - Ay;
            const BCx = p.Cx - p.Bx, BCy = p.Cy - p.By;
            const cross = ABx * BCy - ABy * BCx;
            const dot = ABx * BCx + ABy * BCy;
            const score = Math.abs(cross) / ab;
            const overlapOk = wantOverlap ? (dot < 0) : (dot > 0);

            if (!bestAny || score < bestAny.score) bestAny = { theta, score };
            if (overlapOk && (!bestMatch || score < bestMatch.score)) {
                bestMatch = { theta, score };
            }
        }

        if (bestMatch) return bestMatch.theta;
        return bestAny ? bestAny.theta : null;
    }

    // Extended collinear: AC = a + b
    const AC1 = a + b;
    const cosA1 = (AC1 * AC1 + d * d - c * c) / (2 * AC1 * d);
    const angA1 = Math.acos(Math.max(-1, Math.min(1, cosA1)));
    const theta1Fallback = -angA1;
    let theta1 = pickCollinearTheta([-angA1, angA1], false);
    if (theta1 === null) theta1 = theta1Fallback;

    // Overlap collinear: AC = |b - a|
    const AC2 = Math.abs(b - a);
    let theta2 = null;
    if (AC2 >= 1e-6) {
        const cosA2 = (AC2 * AC2 + d * d - c * c) / (2 * AC2 * d);
        if (Math.abs(cosA2) <= 1) {
            const angA2 = Math.acos(Math.max(-1, Math.min(1, cosA2)));
            theta2 = pickCollinearTheta([Math.PI - angA2, Math.PI + angA2], true);
            if (theta2 === null) theta2 = Math.PI - angA2;
        }
    }

    if (theta2 === null) theta2 = theta1 + Math.PI;
    return { theta1, theta2 };
}

function showExtreme(which) {
    const v = views['svg8'];
    if (!v) return;
    v.stopAnim();
    const btns = document.querySelectorAll('#card-8 .ctrl-btn');
    btns.forEach(b => { if(b.textContent.includes('æš‚åœ')) { b.textContent='â–¶ æ’­æ”¾'; b.classList.remove('active'); }});

    const ext = getExtremeThetas(v.o.a, v.o.b, v.o.c, v.o.d, v.o.Ax, v.o.Ay);
    const theta = which === 1 ? ext.theta1 : ext.theta2;
    v.update(theta);
}

function drawExtremePositions(v) {
    const ext = getExtremeThetas(v.o.a, v.o.b, v.o.c, v.o.d, v.o.Ax, v.o.Ay);
    const p1 = solveFB(ext.theta1, v.o.a, v.o.b, v.o.c, v.o.d, v.o.Ax, v.o.Ay);
    const p2 = solveFB(ext.theta2, v.o.a, v.o.b, v.o.c, v.o.d, v.o.Ax, v.o.Ay);
    if (!p1 || !p2) return;

    v.els.ghostGroup.style.display = '';
    setL(v.els.ghost1Crank, v.o.Ax, v.o.Ay, p1.Bx, p1.By);
    setL(v.els.ghost1Coupler, p1.Bx, p1.By, p1.Cx, p1.Cy);
    setL(v.els.ghost1Rocker, v.Dx, v.Dy, p1.Cx, p1.Cy);
    setL(v.els.ghost2Crank, v.o.Ax, v.o.Ay, p2.Bx, p2.By);
    setL(v.els.ghost2Coupler, p2.Bx, p2.By, p2.Cx, p2.Cy);
    setL(v.els.ghost2Rocker, v.Dx, v.Dy, p2.Cx, p2.Cy);

    // Rocker swing arc
    v.els.extremeGroup.style.display = '';
    const r1 = Math.atan2(p1.Cy-v.Dy, p1.Cx-v.Dx);
    const r2 = Math.atan2(p2.Cy-v.Dy, p2.Cx-v.Dx);
    const arcR = v.o.c;
    // Draw rocker sweep arc (not needed for now, just show theta)

    // Extreme position angle theta at A
    const arc12 = cwDelta(ext.theta1, ext.theta2);
    const arc21 = cwDelta(ext.theta2, ext.theta1);
    const use12AsWork = arc12 >= arc21;
    const workStart = use12AsWork ? ext.theta1 : ext.theta2;
    const workEnd = use12AsWork ? ext.theta2 : ext.theta1;
    const returnStart = use12AsWork ? ext.theta2 : ext.theta1;
    const returnEnd = use12AsWork ? ext.theta1 : ext.theta2;
    const workAngle = use12AsWork ? arc12 : arc21;
    const returnAngle = use12AsWork ? arc21 : arc12;
    const extremeAngle = Math.abs(workAngle - returnAngle) / 2;

    // Draw work stroke arc (blue, larger crank angle) and return stroke arc (red, smaller crank angle)
    const aR = 35;
    function arcPathCW(cx, cy, r, startAng, endAng) {
        const s = normalizeAngle(startAng);
        const diff = cwDelta(startAng, endAng);
        const e = s + diff;
        const sx = cx + r * Math.cos(s), sy = cy + r * Math.sin(s);
        const ex = cx + r * Math.cos(e), ey = cy + r * Math.sin(e);
        const large = diff > Math.PI ? 1 : 0;
        return `M${sx},${sy}A${r},${r} 0 ${large},1 ${ex},${ey}`;
    }

    v.els.workArc.setAttribute('d', arcPathCW(v.o.Ax, v.o.Ay, aR, workStart, workEnd));
    v.els.returnArc.setAttribute('d', arcPathCW(v.o.Ax, v.o.Ay, aR + 6, returnStart, returnEnd));

    // Theta angle label
    const K = (Math.PI + extremeAngle) / (Math.PI - extremeAngle);
    v.els.thetaTxt.setAttribute('x', v.o.Ax - 50);
    v.els.thetaTxt.setAttribute('y', v.o.Ay - 45);
    v.els.thetaTxt.textContent = 'Î¸â‰ˆ' + (extremeAngle*180/Math.PI).toFixed(1) + 'Â°';
}

// ============ Dead points ============
// Dead points for crank-rocker: when rocker drives, dead points occur
// at the extreme positions (crank & coupler collinear).
// These are the same thetas as the extreme positions.
function getDeadThetas(a, b, c, d, Ax, Ay) {
    const ext = getExtremeThetas(a, b, c, d, Ax, Ay);
    return [ext.theta1, ext.theta2];
}

function showDead(which) {
    const v = views['svg10'];
    if (!v) return;
    v.stopAnim();
    const btns = document.querySelectorAll('#card-10 .ctrl-btn');
    btns.forEach(b => { if(b.textContent.includes('æš‚åœ')) { b.textContent='â–¶ æ’­æ”¾'; b.classList.remove('active'); }});

    const deads = getDeadThetas(v.o.a, v.o.b, v.o.c, v.o.d, v.o.Ax, v.o.Ay);
    if (deads.length >= which) {
        v.update(deads[which-1]);
    }
}

// ============ Lab controls ============
function setupLab() {
    const params = ['a','b','c','d'];
    params.forEach(p => {
        const el = document.getElementById('lab-'+p);
        if (!el) return;
        el.addEventListener('input', function() {
            document.getElementById('lab-'+p+'-v').textContent = this.value;
            updateLab();
        });
    });
}

function updateLab() {
    const a = parseInt(document.getElementById('lab-a').value);
    const b = parseInt(document.getElementById('lab-b').value);
    const c = parseInt(document.getElementById('lab-c').value);
    const d = parseInt(document.getElementById('lab-d').value);

    // Check Grashof
    const lengths = [a,b,c,d].sort((x,y)=>x-y);
    const s = lengths[0], l = lengths[3], p = lengths[1], q = lengths[2];
    const grashof = s + l <= p + q;

    document.getElementById('info11-grashof').textContent = grashof ? 'âœ“' : 'âœ—';
    document.getElementById('info11-grashof').className = 'info-value ' + (grashof ? 'good' : 'bad');

    // Determine type
    let type = 'éGrashof';
    if (grashof) {
        if (s === a) type = (s === d) ? 'åŒæ›²æŸ„/æ›²æ‘‡' : 'æ›²æŸ„æ‘‡æ†';
        else if (s === d) type = 'åŒæ›²æŸ„';
        else if (s === b) type = 'åŒæ‘‡æ†';
        else if (s === c) type = 'æ›²æŸ„æ‘‡æ†';
        // More precise: if shortest is crank (a) and adjacent to frame
        if (a === s && (a !== b)) type = 'æ›²æŸ„æ‘‡æ†';
        else if (d === s) type = 'åŒæ›²æŸ„';
        else if (b === s) type = 'åŒæ‘‡æ†';
        else type = 'æ›²æŸ„æ‘‡æ†';
    }
    document.getElementById('info11-type').textContent = type;

    // Update view
    const v = views['svg11'];
    if (!v) return;

    // Recalculate Ax to center the mechanism
    const Ax = 190 - d/2;
    v.o.a = a; v.o.b = b; v.o.c = c; v.o.d = d;
    v.o.Ax = Ax; v.o.Ay = 195;
    const Dx = Ax + d;

    // Update fixed elements
    v.els.jA.setAttribute('cx', Ax);
    v.els.jA.setAttribute('cy', 195);
    v.els.jD.setAttribute('cx', Dx);
    v.els.jD.setAttribute('cy', 195);
    v.els.frame.setAttribute('x1', Ax);
    v.els.frame.setAttribute('y1', 195);
    v.els.frame.setAttribute('x2', Dx);
    v.els.frame.setAttribute('y2', 195);

    // Reset trace
    v.state.tracePoints = [];
    v.els.trace.setAttribute('d','');

    // Try to update current position
    const result = v.update(v.state.theta);

    // Compute mu_min and K
    if (grashof && type.includes('æ›²æŸ„')) {
        let muMin = Math.PI;
        for (let t = 0; t < Math.PI*2; t += 0.01) {
            const pp = solveFB(t, a, b, c, d, Ax, 195);
            if (pp && pp.mu < muMin) muMin = pp.mu;
        }
        const muMinDeg = (muMin * 180 / Math.PI).toFixed(1);
        document.getElementById('info11-mumin').textContent = muMinDeg + 'Â°';
        document.getElementById('info11-mumin').className = 'info-value ' + (muMin*180/Math.PI >= 40 ? 'good' : muMin*180/Math.PI >= 20 ? 'warn' : 'bad');

        // K
        const ext = getExtremeThetas(a, b, c, d, Ax, 195);
        let diff = ext.theta2 - ext.theta1;
        while (diff < 0) diff += 2*Math.PI;
        const work = diff, ret = 2*Math.PI - diff;
        const extremeAng = Math.abs(work - ret) / 2;
        const K = (Math.PI + extremeAng) / (Math.PI - extremeAng);
        document.getElementById('info11-k').textContent = K.toFixed(2);
    } else {
        document.getElementById('info11-mumin').textContent = 'â€”';
        document.getElementById('info11-mumin').className = 'info-value';
        document.getElementById('info11-k').textContent = 'â€”';
    }
}

// ============ Compute min transmission angle ============
function computeMuMin(a, b, c, d, Ax, Ay) {
    let muMin = Math.PI;
    for (let t = 0; t < Math.PI*2; t += 0.005) {
        const p = solveFB(t, a, b, c, d, Ax, Ay);
        if (p && p.mu < muMin) muMin = p.mu;
    }
    return muMin;
}

// ============ Initialize all cards ============
function init() {
    // Card 0: Title hero animation
    createView('svg0', { showGround:true, showLabels:false });

    // Card 1: Components with labels
    createView('svg1', { showGround:true, showLabels:true, crankColor:'#0C8CE9', rockerColor:'#1e8e3e' });
    views['svg1'].update(-0.6);

    // Card 2: Motion demo with trace & slider
    createView('svg2', { showGround:true, showTrace:false });
    setupSlider('slider2', 'svg2');

    // Card 3: Interactive drag
    createView('svg3', {
        showGround:true, interactive:true, showTrace:true,
        crankColor:'#0C8CE9',
        onUpdate: function(th, p) {
            const deg = (th * 180 / Math.PI);
            const d = ((deg % 360) + 360) % 360;
            document.getElementById('info3-theta').textContent = d.toFixed(1) + 'Â°';
            const rockDeg = (p.rockAng * 180 / Math.PI);
            document.getElementById('info3-phi').textContent = ((rockDeg%360+360)%360).toFixed(1) + 'Â°';
            const muDeg = (p.mu * 180 / Math.PI).toFixed(1);
            const muEl = document.getElementById('info3-mu');
            muEl.textContent = muDeg + 'Â°';
            muEl.className = 'info-value ' + (p.mu*180/Math.PI >= 40 ? 'good' : p.mu*180/Math.PI >= 20 ? 'warn' : 'bad');
        }
    });

    // Card 4: Grashof overview - static demo with bar length labels
    createView('svg4', { showGround:true, showLabels:true, Ay:180, crankColor:'#0C8CE9', rockerColor:'#1e8e3e' });
    views['svg4'].update(-0.5);
    // Draw shortest bar highlight on svg4
    drawShortestBarHighlight('svg4');
    // Synchronized mini visualizations for three mechanism types
    initCard4MiniVisuals();

    // Card 5: Crank-Rocker demo (shortest = side link a)
    // a=55(shortest,crank), b=150(coupler), c=100(rocker), d=140(frame)
    createView('svg5cr', {
        showGround:true, showLabels:false, showTrace:false,
        a:55, b:150, c:100, d:140, Ax:100, Ay:210,
        crankColor:'#0C8CE9', couplerColor:'#666', rockerColor:'#1e8e3e'
    });
    drawMechTypeLabels('svg5cr', {type:'crank-rocker', a:55, b:150, c:100, d:140, shortest:'a'});

    // Card 6: Double-Crank demo (shortest = frame d)
    // a=100, b=150, c=120, d=60(shortest,frame)
    createView('svg6dc', {
        showGround:true, showLabels:false, showTrace:false,
        a:100, b:150, c:120, d:60, Ax:140, Ay:210,
        crankColor:'#0C8CE9', couplerColor:'#666', rockerColor:'#1e8e3e'
    });
    // Highlight frame as shortest bar with orange color
    views['svg6dc'].els.frame.setAttribute('stroke', '#e65100');
    views['svg6dc'].els.frame.setAttribute('stroke-dasharray', 'none');
    views['svg6dc'].els.frame.setAttribute('stroke-width', '3');
    drawMechTypeLabels('svg6dc', {type:'double-crank', a:100, b:150, c:120, d:60, shortest:'d'});

    // Card 7: Double-Rocker demo (shortest = coupler b)
    // a=100, b=50(shortest,coupler), c=110, d=140(frame)
    createView('svg7dr', {
        showGround:true, showLabels:false, showTrace:false,
        a:100, b:50, c:110, d:140, Ax:100, Ay:210,
        crankColor:'#0C8CE9', couplerColor:'#e65100', rockerColor:'#1e8e3e'
    });
    drawMechTypeLabels('svg7dr', {type:'double-rocker', a:100, b:50, c:110, d:140, shortest:'b'});
    // Double-rocker: oscillatory motion instead of full rotation
    configureOscillatingView(views['svg7dr'], 0.005);

    // Card 8: Extreme positions
    const v8 = createView('svg8', { showGround:true, Ay:200 });
    drawExtremePositions(v8);

    // Card 9: Transmission angle
    createView('svg9', { showGround:true, showAngle:true });
    setupSlider('slider9', 'svg9');
    const muMin9 = computeMuMin(55, 150, 100, 140, 100, 195);
    document.getElementById('info9-mumin').textContent = (muMin9*180/Math.PI).toFixed(1) + 'Â°';
    const p9init = solveFB(0, 55, 150, 100, 140, 100, 195);
    if (p9init) {
        document.getElementById('info9-mu').textContent = (p9init.mu*180/Math.PI).toFixed(1) + 'Â°';
        document.getElementById('info9-alpha').textContent = (90 - p9init.mu*180/Math.PI).toFixed(1) + 'Â°';
    }
    const sl9 = document.getElementById('slider9');
    function updateCard9Info(th) {
        const p = solveFB(th, 55, 150, 100, 140, 100, 195);
        if (p) {
            const md = (p.mu * 180 / Math.PI).toFixed(1);
            document.getElementById('info9-mu').textContent = md + 'Â°';
            document.getElementById('info9-mu').className = 'info-value ' + (p.mu*180/Math.PI >= 40 ? 'good' : p.mu*180/Math.PI >= 20 ? 'warn' : 'bad');
            document.getElementById('info9-alpha').textContent = (90 - p.mu*180/Math.PI).toFixed(1) + 'Â°';
        }
    }
    sl9.addEventListener('input', function() {
        updateCard9Info(parseFloat(this.value) * Math.PI / 180);
    });

    // Card 10: Dead points with ghost positions
    const v10 = createView('svg10', { showGround:true, showAngle:true });
    const deadThetas = getDeadThetas(v10.o.a, v10.o.b, v10.o.c, v10.o.d, v10.o.Ax, v10.o.Ay);
    const dp1 = solveFB(deadThetas[0], v10.o.a, v10.o.b, v10.o.c, v10.o.d, v10.o.Ax, v10.o.Ay);
    const dp2 = solveFB(deadThetas[1], v10.o.a, v10.o.b, v10.o.c, v10.o.d, v10.o.Ax, v10.o.Ay);
    if (dp1 && dp2) {
        v10.els.ghostGroup.style.display = '';
        setL(v10.els.ghost1Crank, v10.o.Ax, v10.o.Ay, dp1.Bx, dp1.By);
        setL(v10.els.ghost1Coupler, dp1.Bx, dp1.By, dp1.Cx, dp1.Cy);
        setL(v10.els.ghost1Rocker, v10.Dx, v10.Dy, dp1.Cx, dp1.Cy);
        setL(v10.els.ghost2Crank, v10.o.Ax, v10.o.Ay, dp2.Bx, dp2.By);
        setL(v10.els.ghost2Coupler, dp2.Bx, dp2.By, dp2.Cx, dp2.Cy);
        setL(v10.els.ghost2Rocker, v10.Dx, v10.Dy, dp2.Cx, dp2.Cy);
    }

    // Card 11: Lab
    createView('svg11', { showGround:true, showTrace:false });
    setupLab();
    updateLab();

    // Set initial info for card 3
    const p3init = solveFB(0, 55, 150, 100, 140, 100, 195);
    if (p3init) {
        document.getElementById('info3-theta').textContent = '0.0Â°';
        document.getElementById('info3-phi').textContent = (((p3init.rockAng*180/Math.PI)%360+360)%360).toFixed(1) + 'Â°';
        document.getElementById('info3-mu').textContent = (p3init.mu*180/Math.PI).toFixed(1) + 'Â°';
    }

    // Start card 0 animation
    activateCard(0);
}

// ============ Draw mechanism type labels & bar length annotations ============
function drawShortestBarHighlight(svgId) {
    const v = views[svgId];
    if (!v) return;
    // Pulse the crank (shortest bar) in svg4
    v.els.crank.classList.add('shortest-bar-pulse');
}

function drawMechTypeLabels(svgId, cfg) {
    const v = views[svgId];
    if (!v) return;
    const svg = v.svg;
    const o = v.o;
    const Dx = o.Ax + o.d, Dy = o.Ay;

    // Draw bar length labels near each link
    const p = solveFB(v.state.theta, o.a, o.b, o.c, o.d, o.Ax, o.Ay);
    if (!p) return;

    // Helper: add a label group with background
    function addBarLabel(x, y, text, color, isShortest) {
        const g = mkEl(svg, 'g', {});
        const bg = mkEl(g, 'rect', {
            x: x-22, y: y-9, width: 44, height: 18, rx: 4,
            fill: isShortest ? color : '#f5f5f5',
            opacity: isShortest ? 0.2 : 0.8,
            stroke: color, 'stroke-width': isShortest ? 1.5 : 0.5
        });
        const t = mkEl(g, 'text', {
            x: x, y: y, 'font-size': 11, 'font-weight': isShortest ? 700 : 500,
            fill: color, 'text-anchor': 'middle', dy: '.35em'
        });
        t.textContent = text;
        if (isShortest) {
            // Add "æœ€çŸ­" indicator
            const st = mkEl(g, 'text', {
                x: x, y: y + 14, 'font-size': 9, 'font-weight': 600,
                fill: color, 'text-anchor': 'middle', dy: '.35em'
            });
            st.textContent = 'â˜… æœ€çŸ­æ†';
        }
        return g;
    }

    // Crank midpoint
    const cmx = (o.Ax + p.Bx)/2, cmy = (o.Ay + p.By)/2;
    addBarLabel(cmx - 16, cmy - 16, 'a='+o.a, cfg.shortest==='a' ? '#0C8CE9' : '#999', cfg.shortest==='a');

    // Coupler midpoint
    const copmx = (p.Bx + p.Cx)/2, copmy = (p.By + p.Cy)/2;
    addBarLabel(copmx, copmy - 16, 'b='+o.b, cfg.shortest==='b' ? '#e65100' : '#999', cfg.shortest==='b');

    // Rocker midpoint
    const rmx = (Dx + p.Cx)/2, rmy = (Dy + p.Cy)/2;
    addBarLabel(rmx + 20, rmy, 'c='+o.c, cfg.shortest==='c' ? '#1e8e3e' : '#999', cfg.shortest==='c');

    // Frame midpoint
    const fmx = (o.Ax + Dx)/2, fmy = o.Ay + 18;
    addBarLabel(fmx, fmy, 'd='+o.d, cfg.shortest==='d' ? '#e65100' : '#999', cfg.shortest==='d');

    // Highlight the shortest bar with pulse animation
    if (cfg.shortest === 'a') v.els.crank.classList.add('shortest-bar-pulse');
    else if (cfg.shortest === 'b') v.els.coupler.classList.add('shortest-bar-pulse');
    else if (cfg.shortest === 'c') v.els.rocker.classList.add('shortest-bar-pulse');
    else if (cfg.shortest === 'd') v.els.frame.classList.add('shortest-bar-pulse');

    // Draw rotation indicator arcs for cranks
    if (cfg.type === 'crank-rocker') {
        // Full circle arc at A for crank
        drawRotationArc(svg, o.Ax, o.Ay, 20, '#0C8CE9', true);
        // Partial arc at D for rocker
        drawSwingArc(svg, Dx, Dy, 20, '#1e8e3e', o, v);
    } else if (cfg.type === 'double-crank') {
        drawRotationArc(svg, o.Ax, o.Ay, 20, '#0C8CE9', true);
        drawRotationArc(svg, Dx, Dy, 20, '#1e8e3e', true);
    } else if (cfg.type === 'double-rocker') {
        drawSwingArc(svg, o.Ax, o.Ay, 20, '#0C8CE9', o, v);
        drawSwingArc(svg, Dx, Dy, 20, '#1e8e3e', o, v);
    }
}

function drawRotationArc(svg, cx, cy, r, color, full) {
    // Draw a full rotation arrow
    const arc = mkEl(svg, 'path', {
        d: `M${cx+r},${cy}A${r},${r} 0 1,1 ${cx+r-0.01},${cy+0.01}`,
        fill: 'none', stroke: color, 'stroke-width': 1.5, 'stroke-dasharray': '4,2', opacity: 0.6
    });
    // Arrow head
    const ax = cx + r, ay = cy;
    mkEl(svg, 'polygon', {
        points: `${ax},${ay-4} ${ax+6},${ay} ${ax},${ay+4}`,
        fill: color, opacity: 0.6
    });
    // "360Â°" label
    const t = mkEl(svg, 'text', {
        x: cx, y: cy - r - 6, 'font-size': 10, 'font-weight': 600,
        fill: color, 'text-anchor': 'middle', opacity: 0.8
    });
    t.textContent = '360Â°';
}

function drawSwingArc(svg, cx, cy, r, color, o, v) {
    // Draw a partial swing arc indicator
    const arc = mkEl(svg, 'path', {
        d: `M${cx-r*0.7},${cy-r*0.7}A${r},${r} 0 0,1 ${cx+r*0.7},${cy-r*0.7}`,
        fill: 'none', stroke: color, 'stroke-width': 1.5, 'stroke-dasharray': '4,2', opacity: 0.6
    });
    // Double-headed arrow
    const lx = cx-r*0.7, ly = cy-r*0.7;
    const rx = cx+r*0.7, ry = cy-r*0.7;
    mkEl(svg, 'polygon', {
        points: `${lx+4},${ly-3} ${lx-2},${ly+2} ${lx+6},${ly+2}`,
        fill: color, opacity: 0.6
    });
    mkEl(svg, 'polygon', {
        points: `${rx-4},${ry-3} ${rx+2},${ry+2} ${rx-6},${ry+2}`,
        fill: color, opacity: 0.6
    });
    const t = mkEl(svg, 'text', {
        x: cx, y: cy - r - 6, 'font-size': 10, 'font-weight': 600,
        fill: color, 'text-anchor': 'middle', opacity: 0.8
    });
    t.textContent = 'æ‘†åŠ¨';
}

init();
</script>
</body>
</html>
